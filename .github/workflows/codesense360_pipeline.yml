name: üöÄ CodeSense360 Lambda CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Build Lambda package
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt -t build/
          cp -r src build/src
          cp lambda_handler.py build/
          cd build && zip -r ../codesense360_lambda.zip .

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üöÄ Upload Lambda zip to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          S3_KEY="lambda_builds/codesense360_lambda_${TIMESTAMP}.zip"
          echo "Uploading build to s3://codesense360-data/${S3_KEY}"
          aws s3 cp codesense360_lambda.zip s3://codesense360-data/${S3_KEY} \
            --region ${{ secrets.AWS_REGION }}
          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: üöÄ Deploy Lambda from S3
        run: |
          aws lambda update-function-code \
            --function-name codesense360_ingest_lambda \
            --s3-bucket codesense360-data \
            --s3-key ${{ env.S3_KEY }} \
            --region ${{ secrets.AWS_REGION }}

      - name: üßπ Keep only latest 3 Lambda zips
        run: |
          echo "Cleaning up old Lambda builds in S3..."
          aws s3 ls s3://codesense360-data/lambda_builds/ --region ${{ secrets.AWS_REGION }} \
            | sort -r \
            | awk 'NR>3 {print $4}' \
            | while read old_file; do
                echo "Deleting old build: $old_file"
                aws s3 rm s3://codesense360-data/lambda_builds/$old_file --region ${{ secrets.AWS_REGION }}
              done

      - name: ‚úÖ Test Lambda invocation
        run: |
          aws lambda invoke \
            --function-name codesense360_ingest_lambda \
            --cli-binary-format raw-in-base64-out \
            --payload '{"trigger": "post-deploy"}' \
            lambda_response.json
          echo "üîç Lambda response:"
          cat lambda_response.json
